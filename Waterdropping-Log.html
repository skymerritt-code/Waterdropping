<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Waterdropping log</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #controls { padding: 12px; background: #f4f4f4; display: flex; gap: 10px; align-items:center; justify-content: center; flex-wrap:wrap; }
        #map { flex-grow: 1; width: 100%; }
        button { padding: 12px 18px; font-size: 15px; cursor: pointer; border: none; border-radius: 5px; color: white; }
        .dip { background: #3498db; }
        .drop { background: #e74c3c; }
        .export { background: #27ae60; }
        #status { min-width:220px; color:#333; font-size:14px; }
        #clearPanel { position: fixed; left: 12px; bottom: 12px; background: rgba(255,255,255,0.96); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); font-size:13px; z-index:10000; }
        #clearPanel button { padding:8px 12px; font-size:13px; }
        #clearPanel input { padding:6px; font-size:13px; margin-left:6px; }
        @media (max-width: 480px) {
            #clearPanel { left:8px; right:8px; bottom:8px; padding:12px; border-radius:10px; }
            #clearPanel input { display:block; width:100%; margin:8px 0 0 0; }
            #clearPanel div[style*="display:flex"] { flex-direction:column; gap:8px; }
            #clearPanel button { width:100%; }
            #controls { padding:10px; }
            button { padding:10px 14px; font-size:14px; }
        }
    </style>
</head>
<body>

<div id="controls">
    <button class="dip" id="dipButton" onclick="logDip()"> Dip </button>
    <label for="dipGallons" style="display:flex;align-items:center;gap:6px;margin-left:6px;">
        <span style="font-size:14px;color:#333">Gallons</span>
        <select id="dipGallons" style="width:110px;padding:8px;border-radius:5px;border:1px solid #ccc;">
            <option value="400">400</option>
            <option value="500">500</option>
            <option value="660">660</option>
            <option value="1000">1000</option>
            <option value="1500">1500</option>
            <option value="2000">2000</option>
        </select>
    </label>
    <button class="drop" id="dropButton" onclick="logDrop()"> Drop </button>
    <button class="export" onclick="downloadExcel()"> Download Excel </button>
    <div id="status"></div>
</div>

<div id="map"></div>

<div id="clearPanel">
    <button id="startClearBtn" onclick="showClearConfirm()" style="background:#c0392b;color:#fff;border-radius:6px;padding:8px 12px">Clear Today's Log</button>
</div>

<script>
    // Application state
    let dataLog = [];
    let markers = [];
    let hasDipped = false;

    // Initialize map
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Try to center on current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 15);
        }, ()=>{});
    }

    // Persistence helpers (localStorage by date)
    function getTodayKey() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `waterlog-${y}-${m}-${day}`;
    }
    function saveLocalForToday() {
        try { localStorage.setItem(getTodayKey(), JSON.stringify(dataLog)); } catch(e){console.warn('save failed',e)}
    }
    function loadLocalForToday() {
        try {
            const raw = localStorage.getItem(getTodayKey());
            if (raw) {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    dataLog = parsed;
                    hasDipped = dataLog.some(e=>e.Event==='Dip');
                }
            }
        } catch(e){console.warn('load failed',e)}
    }

    function restoreMarkers() {
        if (!dataLog || dataLog.length===0) return;
        dataLog.forEach(entry=>{
            if (entry.Latitude && entry.Longitude) {
                const color = entry.Event==='Dip' ? 'blue' : 'red';
                const m = L.circleMarker([entry.Latitude, entry.Longitude], { color: color, radius: 10 }).addTo(map)
                    .bindPopup(`${entry.Event}${entry.Gallons ? ' - ' + entry.Gallons + ' gal' : ''}<br>${entry.Timestamp}`);
                markers.push(m);
            }
        });
    }

    // Load saved log and restore markers
    loadLocalForToday();
    restoreMarkers();

    // UI helpers
    function setStatus(msg, timeout=3000) {
        const s = document.getElementById('status');
        if (!s) return;
        s.textContent = msg;
        if (timeout) { clearTimeout(s._st); s._st = setTimeout(()=>s.textContent='',(timeout)); }
    }

    // Logging
    function logDip(){
        const gallons = parseFloat(document.getElementById('dipGallons').value)||0;
        if (gallons<=0) return setStatus('Select gallons');
        logEvent('Dip', gallons);
        hasDipped = true;
    }
    function logDrop(){
        if (!hasDipped) return setStatus('First action must be Dip — press Dip first');
        const gallons = parseFloat(document.getElementById('dipGallons').value)||0;
        if (gallons<=0) return setStatus('Select gallons');
        logEvent('Drop', gallons);
    }

    function logEvent(type, gallons){
        // if geolocation unavailable, still record entry without coords
        if (!navigator.geolocation) {
            const entry = { Event:type, Timestamp:new Date().toLocaleString(), Latitude:'', Longitude:'', Gallons:typeof gallons!=='undefined'?gallons:'' };
            dataLog.push(entry); saveLocalForToday(); setStatus(`${type} logged (no geolocation)`); return;
        }
        navigator.geolocation.getCurrentPosition(pos=>{
            const entry = { Event:type, Timestamp:new Date().toLocaleString(), Latitude: pos.coords.latitude, Longitude: pos.coords.longitude, Gallons:typeof gallons!=='undefined'?gallons:'' };
            dataLog.push(entry); saveLocalForToday();
            const color = type==='Dip' ? 'blue' : 'red';
            const marker = L.circleMarker([entry.Latitude, entry.Longitude], { color: color, radius: 10 }).addTo(map)
                .bindPopup(`${type}${entry.Gallons ? ' - ' + entry.Gallons + ' gal' : ''}<br>${entry.Timestamp}`).openPopup();
            markers.push(marker);
            setStatus(`${type} logged`);
        }, err=>{
            const entry = { Event:type, Timestamp:new Date().toLocaleString(), Latitude:'', Longitude:'', Gallons:typeof gallons!=='undefined'?gallons:'' };
            dataLog.push(entry); saveLocalForToday(); setStatus(`${type} logged (no position)`);
        }, { enableHighAccuracy:true, timeout:10000 });
    }

    function removeAllMarkers(){ markers.forEach(m=>{try{map.removeLayer(m);}catch(e){} }); markers = []; }

    // Clear with single-code confirmation (mobile-friendly)
    function showClearConfirm(){
        const panel = document.getElementById('clearPanel'); if(!panel) return;
        const code = String(Math.floor(1000 + Math.random()*9000)); panel._code = code;
        panel.innerHTML = `
            <div>To clear today's log, type the code <strong>${code}</strong> below:</div>
            <div style="margin-top:8px"><input id="clearCodeInput" placeholder="enter code" oninput="updateClearConfirmState()" style="padding:8px;font-size:15px"></div>
            <div style="margin-top:8px;display:flex;gap:6px;"><button id="confirmClearBtn" disabled style="background:#c0392b;color:#fff;border-radius:6px;padding:8px 12px" onclick="performClear()">Confirm Clear</button><button onclick="cancelClearConfirm()">Cancel</button></div>
        `;
        setTimeout(()=>{ const inp=document.getElementById('clearCodeInput'); if(inp) inp.focus(); },50);
    }
    function updateClearConfirmState(){ const panel=document.getElementById('clearPanel'); if(!panel) return; const code=panel._code; const codeInput=document.getElementById('clearCodeInput'); const confirmBtn=document.getElementById('confirmClearBtn'); if(!confirmBtn||!codeInput) return; confirmBtn.disabled = codeInput.value.trim()!==String(code); }
    function cancelClearConfirm(){ const panel=document.getElementById('clearPanel'); if(!panel) return; panel.innerHTML = '<button id="startClearBtn" onclick="showClearConfirm()" style="background:#c0392b;color:#fff;border-radius:6px;padding:8px 12px">Clear Today\'s Log</button>'; }
    function performClear(){ try{ localStorage.removeItem(getTodayKey()); }catch(e){} dataLog=[]; hasDipped=false; removeAllMarkers(); setStatus("Today's log cleared"); cancelClearConfirm(); }

    // Export UI: ask helicopter number, include in filename as -<input> and date MMDDYYYY
    function downloadExcel(){ if (dataLog.length===0) return setStatus('No data to export yet!'); showExportPrompt(); }
    function showExportPrompt(){ let modal=document.getElementById('exportModal'); if(!modal){ modal=document.createElement('div'); modal.id='exportModal'; modal.style.position='fixed'; modal.style.left='50%'; modal.style.top='50%'; modal.style.transform='translate(-50%,-50%)'; modal.style.zIndex=20000; modal.style.background='white'; modal.style.padding='14px'; modal.style.borderRadius='8px'; modal.style.boxShadow='0 6px 20px rgba(0,0,0,0.25)'; modal.style.minWidth='260px'; modal.style.maxWidth='90%'; modal.innerHTML=`<div style="font-weight:600;margin-bottom:8px">Export Excel</div><div style="font-size:13px;margin-bottom:8px">Enter helicopter number to include in filename:</div><input id="exportHeliInput" placeholder="Helicopter #" style="width:100%;padding:8px;font-size:14px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px"><div style="display:flex;gap:8px;justify-content:flex-end"><button id="exportCancelBtn">Cancel</button><button id="exportConfirmBtn" style="background:#27ae60;color:#fff;border-radius:6px;padding:8px 12px">Export</button></div>`; document.body.appendChild(modal); document.getElementById('exportCancelBtn').onclick = ()=>{ modal.remove(); }; document.getElementById('exportConfirmBtn').onclick = ()=>{ const heli=document.getElementById('exportHeliInput').value.trim(); performExport(heli); modal.remove(); }; setTimeout(()=>{ const i=document.getElementById('exportHeliInput'); if(i) i.focus(); },50); } }
    function performExport(helicopterNumber){ try{ const worksheet = XLSX.utils.json_to_sheet(dataLog); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'Water Log'); const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); const dateStr = `${m}${day}${y}`; const heliPart = helicopterNumber ? `-${helicopterNumber}` : ''; const filename = `Waterdropping_log${heliPart}-${dateStr}.xlsx`; XLSX.writeFile(workbook, filename); setStatus(`Exported ${filename}`,4000); }catch(e){ console.error(e); setStatus('Export failed'); } }

    // Service worker registration for offline caching (if available)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(()=>{
            console.log('Service worker registered');
        }).catch(()=>{ console.warn('Service worker registration failed'); });
    }
</script>
</body>
</html>